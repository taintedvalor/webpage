<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Admin Panel</h1>

    <!-- Search bar in the top right corner -->
    <div class="search-container">
        <input type="text" id="adminSearchInput" placeholder="Search by problem name">
    </div>

    <!-- Problem tracker in the middle -->
    <div id="admin-container">
        <!-- Existing problems will be loaded dynamically here via JavaScript -->
    </div>

    <!-- Modpack version information -->
    <div id="modpackVersion"></div>

    <script>
        const adminContainer = document.getElementById("admin-container");
        const adminSearchInput = document.getElementById("adminSearchInput");
        const modpackVersion = document.getElementById("modpackVersion");

        // Function to load problems from the server
        async function loadProblems() {
            const response = await fetch('/problems');
            const problems = await response.json();

            adminContainer.innerHTML = ''; // Clear existing problems

            problems.forEach(problem => {
                const problemDiv = createAdminProblemElement(problem);
                adminContainer.appendChild(problemDiv);
            });
        }

        // Function to create an admin problem element
        function createAdminProblemElement(problem) {
            const adminProblemDiv = document.createElement("div");
            adminProblemDiv.className = `problem ${problem.status}`;
            adminProblemDiv.innerHTML = `
                <div class="problem-header">${problem.title}</div>
                <div>Status: ${problem.status}</div>

                <!-- Status dropdown -->
                <select class="status-dropdown" data-id="${problem.id}">
                    <option value="Ongoing" ${problem.status === "Ongoing" ? "selected" : ""}>Ongoing</option>
                    <option value="Completed" ${problem.status === "Completed" ? "selected" : ""}>Completed</option>
                    <option value="Unattended" ${problem.status === "Unattended" ? "selected" : ""}>Unattended</option>
                </select>

                <!-- Update button (only if the user created the problem) -->
                ${problem.editable ? `<button class="update-button" data-id="${problem.id}">Update</button>` : ''}

                <!-- Delete button (only if the user created the problem) -->
                ${problem.editable ? `<button class="delete-button" data-id="${problem.id}">Delete</button>` : ''}
            `;

            // Add event listeners for updating and deleting (only if the user created the problem)
            if (problem.editable) {
                const statusDropdown = adminProblemDiv.querySelector(".status-dropdown");
                const updateButton = adminProblemDiv.querySelector(".update-button");
                const deleteButton = adminProblemDiv.querySelector(".delete-button");

                statusDropdown.addEventListener("change", () => {
                    updateProblemStatus(problem.id, statusDropdown.value);
                });

                updateButton.addEventListener("click", () => {
                    updateProblemStatus(problem.id, statusDropdown.value);
                });

                deleteButton.addEventListener("click", () => {
                    deleteProblem(problem.id);
                });
            }

            return adminProblemDiv;
        }

        // Function to update a problem's status
        async function updateProblemStatus(id, status) {
            const response = await fetch(`/problems/${id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status }),
            });

            if (response.status === 204) {
                loadProblems();
            }
        }

        // Function to delete a problem
        async function deleteProblem(id) {
            const response = await fetch(`/problems/${id}`, {
                method: 'DELETE',
            });

            if (response.status === 204) {
                loadProblems();
            }
        }

        // Function to filter problems by name in the admin panel
        function filterAdminProblemsByName() {
            const searchValue = adminSearchInput.value.toLowerCase();
            const adminProblemElements = Array.from(adminContainer.getElementsByClassName("problem"));

            adminProblemElements.forEach(adminProblemDiv => {
                const problemHeader = adminProblemDiv.querySelector(".problem-header").textContent.toLowerCase();
                if (problemHeader.includes(searchValue)) {
                    adminProblemDiv.style.display = "block";
                } else {
                    adminProblemDiv.style.display = "none";
                }
            });
        }

        // Attach event listeners
        adminSearchInput.addEventListener("input", filterAdminProblemsByName);

        // Load existing problems when the admin panel page loads
        loadProblems();

        // Set the modpack version (you can replace this with actual version information)
        modpackVersion.textContent = "Modpack Version: Customizable";
    </script>
</body>
</html>

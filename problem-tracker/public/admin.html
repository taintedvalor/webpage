<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Admin Panel</h1>

    <!-- Search bar in the admin panel -->
    <input type="text" id="adminSearchInput" placeholder="Search by problem name">

    <!-- Admin features will be added here -->
    <div id="admin-container">
        <!-- Existing problems will be loaded dynamically here via JavaScript -->
    </div>

    <script>
        const adminContainer = document.getElementById("admin-container");
        const adminSearchInput = document.getElementById("adminSearchInput");

        // Function to load problems from the server
        async function loadProblems() {
            const response = await fetch('/problems');
            const problems = await response.json();

            adminContainer.innerHTML = ''; // Clear existing problems

            problems.forEach(problem => {
                const problemDiv = createAdminProblemElement(problem);
                adminContainer.appendChild(problemDiv);
            });
        }

        // Function to create an admin problem element
        function createAdminProblemElement(problem) {
            const adminProblemDiv = document.createElement("div");
            adminProblemDiv.className = `problem ${problem.status}`;
            adminProblemDiv.innerHTML = `
                <div class="problem-header">${problem.title}</div>
                <div>Status: ${problem.status}</div>

                <!-- Status dropdown -->
                <select class="status-dropdown" data-id="${problem.id}">
                    <option value="Ongoing" ${problem.status === "Ongoing" ? "selected" : ""}>Ongoing</option>
                    <option value="Completed" ${problem.status === "Completed" ? "selected" : ""}>Completed</option>
                    <option value="Unattended" ${problem.status === "Unattended" ? "selected" : ""}>Unattended</option>
                </select>

                <!-- Update button -->
                <button class="update-button" data-id="${problem.id}">Update</button>

                <!-- Delete button -->
                <button class="delete-button" data-id="${problem.id}">Delete</button>
            `;

            // Add an event listener to update the problem status
            const statusDropdown = adminProblemDiv.querySelector(".status-dropdown");
            statusDropdown.addEventListener("change", () => {
                updateProblemStatus(problem.id, statusDropdown.value);
            });

            // Add an event listener to delete the problem
            const deleteButton = adminProblemDiv.querySelector(".delete-button");
            deleteButton.addEventListener("click", () => {
                deleteProblem(problem.id);
            });

            return adminProblemDiv;
        }

        // Function to update a problem's status
        async function updateProblemStatus(id, status) {
            const response = await fetch(`/problems/${id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status }),
            });

            if (response.status === 204) {
                loadProblems();
            }
        }

        // Function to delete a problem
        async function deleteProblem(id) {
            const response = await fetch(`/problems/${id}`, {
                method: 'DELETE',
            });

            if (response.status === 204) {
                loadProblems();
            }
        }

        // Function to filter problems by name in the admin panel
        function filterAdminProblemsByName() {
            const searchValue = adminSearchInput.value.toLowerCase();
            const adminProblemElements = Array.from(adminContainer.getElementsByClassName("problem"));

            adminProblemElements.forEach(adminProblemDiv => {
                const problemHeader = adminProblemDiv.querySelector(".problem-header").textContent.toLowerCase();
                if (problemHeader.includes(searchValue)) {
                    adminProblemDiv.style.display = "block";
                } else {
                    adminProblemDiv.style.display = "none";
                }
            });
        }

        // Attach event listeners
        adminSearchInput.addEventListener("input", filterAdminProblemsByName);

        // Load existing problems when the admin panel page loads
        loadProblems();
    </script>
</body>
</html>
